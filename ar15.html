<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Sijaintikohde</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #000;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #info-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
            color: white;
            z-index: 10;
        }

        #info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        #info-details {
            font-size: 14px;
        }

        #info-details > div {
            margin-bottom: 4px;
        }

        #error-message {
            margin-top: 8px;
            padding: 8px;
            background: rgba(239, 68, 68, 0.8);
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.9);
            z-index: 20;
            padding: 32px;
            text-align: center;
        }

        #start-screen h1 {
            color: white;
            font-size: 28px;
            margin: 16px 0 8px 0;
        }

        #start-screen p {
            color: #ccc;
            margin-bottom: 24px;
        }

        #start-button {
            padding: 12px 24px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #start-button:hover {
            background: #1d4ed8;
        }

        #fullscreen-button {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: rgba(0,0,0,0.6);
            border: 2px solid white;
            border-radius: 8px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 15;
            display: none;
        }

        #fullscreen-button:hover {
            background: rgba(0,0,0,0.8);
        }

        .instructions {
            margin-top: 32px;
            color: #999;
            font-size: 14px;
            max-width: 400px;
        }

        .instructions ul {
            text-align: left;
            margin-top: 8px;
            list-style-position: inside;
        }

        .instructions li {
            margin-bottom: 4px;
        }

        #target-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            color: white;
            z-index: 10;
            font-size: 14px;
        }

        .target-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .target-coords {
            color: #ccc;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Video stream -->
        <video id="video" autoplay playsinline></video>

        <!-- AR Canvas -->
        <canvas id="canvas"></canvas>

        <!-- Fullscreen button -->
        <button id="fullscreen-button" title="Koko n√§ytt√∂">‚õ∂</button>

        <!-- Info overlay -->
        <div id="info-overlay" class="hidden">
            <div id="info-header">
                üìç AR Sijaintikohde
            </div>
            <div id="info-details">
                <div id="location-info">Haetaan sijaintia...</div>
                <div id="accuracy-info"></div>
                <div id="heading-info"></div>
            </div>
            <div id="error-message"></div>
        </div>

        <!-- Start screen -->
        <div id="start-screen">
            <div style="font-size: 64px;">üì∑</div>
            <h1>AR-katselu</h1>
            <p>N√§e kohteet ymp√§rill√§si lis√§tyn todellisuuden avulla</p>
            <button id="start-button">
                üß≠ K√§ynnist√§ AR
            </button>
            <div class="instructions">
                <p>Huom:</p>
                <ul>
                    <li>Salli sijainti ja kamera</li>
                    <li>Toimii parhaiten mobiililaitteilla</li>
                    <li>Vaatii kompassin (magnetometri)</li>
                </ul>
            </div>
        </div>

        <!-- Target info -->
        <div id="target-info" class="hidden">
            <div class="target-name">Kohde: <span id="target-name"></span></div>
            <div class="target-coords" id="target-coords"></div>
        </div>
    </div>

    <script>
        // Muuttujat
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const infoOverlay = document.getElementById('info-overlay');
        const targetInfo = document.getElementById('target-info');
        const startButton = document.getElementById('start-button');
        const errorMessage = document.getElementById('error-message');
        const fullscreenButton = document.getElementById('fullscreen-button');
        const container = document.getElementById('container');

        let userLocation = null;
        let deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
        let animationFrameId = null;

        // Kohteen koordinaatit (Helsingin tuomiokirkko esimerkkin√§)
        const targetLocation = {
            lat: 60.1708,
            lng: 24.9522,
            name: "Kohde"
        };

        // P√§ivit√§ kohteen tiedot
        document.getElementById('target-name').textContent = targetLocation.name;
        document.getElementById('target-coords').textContent = 
            `${targetLocation.lat.toFixed(6)}, ${targetLocation.lng.toFixed(6)}`;

        // N√§yt√§ virheviesti
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // Pyyd√§ orientaatio-oikeus (iOS)
        async function requestOrientationPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        showError('Orientaatio-oikeus ev√§tty');
                        return false;
                    }
                } catch (err) {
                    showError('Virhe orientaatio-oikeutta pyydett√§ess√§: ' + err.message);
                    return false;
                }
            }
            return true;
        }

        // K√§ynnist√§ kamera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                return true;
            } catch (err) {
                showError('Kameran k√§ynnistys ep√§onnistui: ' + err.message);
                return false;
            }
        }

        // Hae sijainti
        function startGeolocation() {
            if (!navigator.geolocation) {
                showError('Geolocation ei tuettu');
                return;
            }

            navigator.geolocation.watchPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    updateLocationInfo();
                },
                (err) => {
                    showError('Sijainnin haku ep√§onnistui: ' + err.message);
                },
                { enableHighAccuracy: true, maximumAge: 0 }
            );
        }

        // P√§ivit√§ sijaintitiedot
        function updateLocationInfo() {
            if (!userLocation) return;
            document.getElementById('location-info').textContent = 
                `Sijainti: ${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`;
            document.getElementById('accuracy-info').textContent = 
                `Tarkkuus: ¬±${userLocation.accuracy.toFixed(0)}m`;
        }

        // Kuuntele orientaatiota
        function startOrientationTracking() {
            window.addEventListener('deviceorientation', (event) => {
                deviceOrientation = {
                    alpha: event.alpha || 0,   // Kompassi
                    beta: event.beta || 0,     // Kallistus eteen/taakse (-180 - 180)
                    gamma: event.gamma || 0    // Kallistus sivulle (-90 - 90)
                };
                
                // N√§ytet√§√§n suoraan alpha-arvo (0¬∞ = pohjoinen, 90¬∞ = it√§ jne.)
                document.getElementById('heading-info').textContent = 
                    `Suunta: ${deviceOrientation.alpha.toFixed(0)}¬∞ | Beta: ${deviceOrientation.beta.toFixed(0)}¬∞ | Gamma: ${deviceOrientation.gamma.toFixed(0)}¬∞`;
            });
        }

        // Laske et√§isyys (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // Laske suuntakulma
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                      Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
            const Œ∏ = Math.atan2(y, x);

            return (Œ∏ * 180 / Math.PI + 360) % 360;
        }

        // Piirry AR-n√§kym√§
        function drawAR() {
            if (!userLocation) {
                animationFrameId = requestAnimationFrame(drawAR);
                return;
            }

            // Aseta canvasin koko videon mukaan
            canvas.width = video.videoWidth || canvas.width;
            canvas.height = video.videoHeight || canvas.height;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Laske kohteen sijainti
            const distance = calculateDistance(
                userLocation.lat,
                userLocation.lng,
                targetLocation.lat,
                targetLocation.lng
            );

            const bearing = calculateBearing(
                userLocation.lat,
                userLocation.lng,
                targetLocation.lat,
                targetLocation.lng
            );

            // Laske kohteen korkeus/korkeuskulma (yksinkertaistettu)
            // Oletetaan ett√§ kohde on maassa, katsotaan vaakasuorassa
            const elevationAngle = 0; // Voidaan laajentaa my√∂hemmin

            // Tarkista horisontaalinen suunta (k√§ytet√§√§n alphaa kompassina)
            const deviceHeading = deviceOrientation.alpha;
            let angleDiff = bearing - deviceHeading;
            if (angleDiff > 180) angleDiff -= 360;
            if (angleDiff < -180) angleDiff += 360;

            // Pystysuuntainen kulma (beta kertoo puhelimen kallistuksen)
            // Beta: 0 = pysty, 90 = vaaka eteenp√§in, -90 = vaaka taaksep√§in
            // Kun puhelin on pystyasennossa (beta ~0-20), n√§ytet√§√§n kohde
            const verticalAngle = deviceOrientation.beta;
            
            // FOV (field of view) - n√§k√∂kentt√§
            const horizontalFOV = 60; // Vaakasuuntainen n√§k√∂kentt√§
            const verticalFOV = 45;   // Pystysuuntainen n√§k√∂kentt√§
            
            // Tarkista onko kohde n√§kyviss√§ horisontaalisesti
            if (Math.abs(angleDiff) < horizontalFOV / 2) {
                // Laske kohteen X-sijainti (horisontaalinen)
                const x = canvas.width / 2 - (angleDiff / (horizontalFOV / 2)) * (canvas.width / 2);
                
                // Laske kohteen Y-sijainti (vertikaalinen)
                // Kun beta on ~0-20 (puhelin pystyasennossa), kohde n√§kyy keskell√§
                // Jos beta kasvaa (kallistat eteenp√§in), kohde siirtyy yl√∂s
                const verticalOffset = (verticalAngle - 10) / verticalFOV; // 10¬∞ on "normaali" katselukulma
                const y = canvas.height / 2 - verticalOffset * canvas.height;

                // Piirry vain jos kohde on n√§kyviss√§ my√∂s vertikaalisesti
                if (y > -50 && y < canvas.height + 50) {
                    // Piirry punainen ympyr√§
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                    ctx.beginPath();
                    ctx.arc(x, y, 20, 0, 2 * Math.PI);
                    ctx.fill();

                    // Piirry kohteen nimi
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.shadowColor = 'black';
                    ctx.shadowBlur = 4;
                    ctx.fillText(targetLocation.name, x, y - 30);
                    
                    // Piirry et√§isyys
                    ctx.fillText(`${distance.toFixed(0)}m`, x, y + 45);
                    
                    // Piirry suuntakulma (debug)
                    ctx.font = '12px Arial';
                    ctx.fillText(`${bearing.toFixed(0)}¬∞`, x, y + 65);
                    ctx.shadowBlur = 0;
                }
            }

            animationFrameId = requestAnimationFrame(drawAR);
        }

        // Fullscreen-toiminnot
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Siirry fullscreeniin
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) { // Safari
                    container.webkitRequestFullscreen();
                } else if (container.mozRequestFullScreen) { // Firefox
                    container.mozRequestFullScreen();
                } else if (container.msRequestFullscreen) { // IE/Edge
                    container.msRequestFullscreen();
                }
            } else {
                // Poistu fullscreenist√§
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // P√§ivit√§ fullscreen-napin ulkoasu
        function updateFullscreenButton() {
            if (document.fullscreenElement) {
                fullscreenButton.textContent = '‚äó'; // Exit fullscreen ikoni
                fullscreenButton.title = 'Poistu koko n√§yt√∂st√§';
            } else {
                fullscreenButton.textContent = '‚õ∂'; // Enter fullscreen ikoni
                fullscreenButton.title = 'Koko n√§ytt√∂';
            }
        }

        // Kuuntele fullscreen-muutoksia
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);

        // Fullscreen-napin toiminto
        fullscreenButton.addEventListener('click', toggleFullscreen);

        // K√§ynnist√§ AR
        startButton.addEventListener('click', async () => {
            const orientationOk = await requestOrientationPermission();
            if (!orientationOk) return;

            const cameraOk = await startCamera();
            if (!cameraOk) return;

            startScreen.classList.add('hidden');
            infoOverlay.classList.remove('hidden');
            targetInfo.classList.remove('hidden');
            fullscreenButton.style.display = 'block';

            // Siirry automaattisesti fullscreeniin
            try {
                if (container.requestFullscreen) {
                    await container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    await container.webkitRequestFullscreen();
                } else if (container.mozRequestFullScreen) {
                    await container.mozRequestFullScreen();
                } else if (container.msRequestFullscreen) {
                    await container.msRequestFullscreen();
                }
            } catch (err) {
                console.log('Fullscreen ei onnistunut:', err);
                // Jatka silti normaalisti
            }

            startGeolocation();
            startOrientationTracking();
            
            // Odota ett√§ video on valmis
            video.addEventListener('loadeddata', () => {
                drawAR();
            });
        });
    </script>
</body>
</html>