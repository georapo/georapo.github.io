<!doctype html>
<html lang="fi">
<meta charset="utf-8"/>
<title>AR-kompassi</title>
<style>
  html,body {margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui;}
  #cam {position:fixed;inset:0;object-fit:cover;transform:scaleX(-1);}
  #hud {position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
        background:rgba(0,0,0,0.5);border-radius:12px;padding:10px 16px;text-align:center;z-index:10;}
  #arrow {width:80px;height:80px;display:block;margin:0 auto;transition:transform 0.05s linear;}
  #info {font-size:14px;margin-top:8px;text-align:center;}
  #debug {position:fixed;bottom:0;left:0;width:100%;font-size:12px;text-align:center;
          background:rgba(0,0,0,0.7);color:#0f0;padding:4px;white-space:pre-wrap;}
  canvas {position:fixed;inset:0;pointer-events:none;}
  #permissionScreen {
    position:fixed;inset:0;background:rgba(0,0,0,0.85);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    text-align:center;z-index:50;color:#fff;font-size:18px;padding:20px;
  }
  #permissionScreen button {
    margin-top:20px;padding:12px 24px;font-size:18px;border:none;border-radius:12px;
    background:#0a84ff;color:#fff;font-weight:600;
  }
  #permissionScreen button:active {background:#0068d6;}
</style>
<body>

<video id="cam" autoplay playsinline muted></video>

<div id="hud">
  <img id="arrow" src="data:image/svg+xml;utf8,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
      <polygon points='50,5 95,95 50,75 5,95' fill='white'/>
    </svg>"/>
  <div id="info">
    <div id="dist">Et√§isyys: ‚Äî</div>
    <div id="bearing">Kohteen suunta: ‚Äî¬∞</div>
    <div id="azimuth">Kallistus: ‚Äî¬∞</div>
  </div>
</div>

<div id="debug"></div>

<div id="permissionScreen">
  <div>üì± Sovellus tarvitsee p√§√§syn liikesensoriin (kompassi) ja kameraan.</div>
  <button id="permitBtn">Salli liikesensori</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.min.js"></script>
<script>
const toRad = d => d*Math.PI/180;
const toDeg = r => r*180/Math.PI;
const norm360 = a => (a%360+360)%360;

function haversineDistance(lat1,lon1,lat2,lon2){
  const R=6371000;const œÜ1=toRad(lat1),œÜ2=toRad(lat2),dœÜ=toRad(lat2-lat1),dŒª=toRad(lon2-lon1);
  return 2*R*Math.asin(Math.sqrt(Math.sin(dœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2));
}
function initialBearing(lat1,lon1,lat2,lon2){
  const œÜ1=toRad(lat1),œÜ2=toRad(lat2),ŒîŒª=toRad(lon2-lon1);
  const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  return norm360(toDeg(Math.atan2(y,x)));
}
function rotateVectorByQuat(v,q){
  const x=v.x,y=v.y,z=v.z;
  const qx=q.x,qy=q.y,qz=q.z,qw=q.w;
  const ix= qw*x + qy*z - qz*y;
  const iy= qw*y + qz*x - qx*z;
  const iz= qw*z + qx*y - qy*x;
  const iw= -qx*x - qy*y - qz*z;
  return {
    x: ix*qw + iw*-qx + iy*-qz - iz*-qy,
    y: iy*qw + iw*-qy + iz*-qx - ix*-qz,
    z: iz*qw + iw*-qz + ix*-qy - iy*-qx
  };
}

/* --- Tilamuuttujat --- */
let currentPos=null;
let haveOrientation=false;
let orientationQuat=new THREE.Quaternion();
let show3D=false;
let pitchDeg=0;
const target={lat:60.1699,lon:24.9384}; // Helsinki
const debugEl=document.getElementById('debug');
function debug(msg){debugEl.textContent=msg;}

/* --- Kamera --- */
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
  .then(s=>{cam.srcObject=s;}).catch(e=>debug("Kameravirhe: "+e));

/* --- GPS --- */
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    currentPos={lat:pos.coords.latitude,lon:pos.coords.longitude};
  },err=>debug("GPS virhe: "+err.message),{enableHighAccuracy:true});
}

/* --- THREE.js 3D-nuoli --- */
const scene=new THREE.Scene();
const camera3d=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,100);
const renderer=new THREE.WebGLRenderer({alpha:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);
const shaftGeom=new THREE.CylinderGeometry(0.05,0.05,1,8);
const headGeom=new THREE.ConeGeometry(0.1,0.3,12);
const shaftMat=new THREE.MeshBasicMaterial({color:0xffffff});
const headMat=new THREE.MeshBasicMaterial({color:0xff0000});
const shaft=new THREE.Mesh(shaftGeom,shaftMat);
const head=new THREE.Mesh(headGeom,headMat);
head.position.y=0.65;
scene.add(shaft);scene.add(head);
camera3d.position.z=3;
renderer.domElement.style.opacity=0;

/* --- Liikesensori / napin tapahtuma --- */
document.getElementById('permitBtn').onclick = async () => {
  const overlay=document.getElementById('permissionScreen');

  try {
    // iOS: pyydet√§√§n lupaa
    if(typeof DeviceOrientationEvent?.requestPermission==='function'){
      const res = await DeviceOrientationEvent.requestPermission().catch(()=> 'denied');
      if(res!=='granted'){
        debug("‚ùå Liikesensorin k√§ytt√∂ estetty iOS:ssa.");
        overlay.querySelector('div').innerHTML="‚ùå Et antanut lupaa liikesensoreihin.";
        return;
      }
    }

    // Android ja muut: listener lis√§t√§√§n suoraan
    window.addEventListener('deviceorientation', handleOrientation, true);
    overlay.style.display='none';
    debug("‚úÖ Liikesensori sallittu, kuuntelu k√§ynniss√§.");

  } catch(e){
    debug("Virhe lupaa pyydett√§ess√§: "+e);
  }
};

function handleOrientation(ev){
  if(ev.alpha===null && ev.beta===null && ev.gamma===null) return;
  const q=new THREE.Quaternion().setFromEuler(
    new THREE.Euler(toRad(ev.beta),toRad(ev.alpha),-toRad(ev.gamma),'YXZ')
  );
  orientationQuat.copy(q);
  haveOrientation=true;
}

/* --- HUD / p√§ivitys --- */
const arrow2d=document.getElementById('arrow');
function updateHUD(){
  requestAnimationFrame(updateHUD);
  if(!currentPos || !haveOrientation) return;

  const dist=haversineDistance(currentPos.lat,currentPos.lon,target.lat,target.lon);
  const bearing=initialBearing(currentPos.lat,currentPos.lon,target.lat,target.lon);
  document.getElementById('dist').textContent=`Et√§isyys: ${dist<1000?Math.round(dist)+' m':(dist/1000).toFixed(2)+' km'}`;
  document.getElementById('bearing').textContent=`Kohteen suunta: ${bearing.toFixed(1)}¬∞`;

  const R=6371000;
  const œÜ1=toRad(currentPos.lat),Œª1=toRad(currentPos.lon);
  const œÜ2=toRad(target.lat),Œª2=toRad(target.lon);
  const dœÜ=œÜ2-œÜ1,dŒª=Œª2-Œª1;
  const east=R*Math.cos(œÜ1)*dŒª;
  const north=R*dœÜ;
  const enu=new THREE.Vector3(east,north,0).normalize();

  const forward=rotateVectorByQuat({x:0,y:0,z:-1},orientationQuat);
  const worldForward=new THREE.Vector3(forward.x,forward.y,forward.z).normalize();
  const pitch=Math.asin(-worldForward.z);
  pitchDeg=toDeg(pitch);
  show3D=pitchDeg>45;
  arrow2d.style.opacity=show3D?0:1;
  renderer.domElement.style.opacity=show3D?1:0;

  if(show3D){
    const quatToTarget=new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0,1,0),enu);
    shaft.quaternion.copy(quatToTarget);
    head.quaternion.copy(quatToTarget);
    renderer.render(scene,camera3d);
  }

  document.getElementById('azimuth').textContent=`Kallistus: ${pitchDeg.toFixed(1)}¬∞`;
  debug(`GPS: ${currentPos.lat?.toFixed(5)}, ${currentPos.lon?.toFixed(5)}\nOrientQuat z:${orientationQuat.z.toFixed(2)}`);
}
updateHUD();
</script>
</body>
</html>
