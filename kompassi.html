<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>AR-pistetähtäin</title>
<style>
  html,body {margin:0; height:100%; overflow:hidden; background:#000;}
  video {position:fixed; inset:0; object-fit:cover; width:100%; height:100%; z-index:0;}
  #dot {
    position:fixed; width:20px; height:20px; border-radius:50%;
    background:red; box-shadow:0 0 15px 5px rgba(255,0,0,0.6);
    z-index:2; transform:translate(-50%,-50%); display:none;
  }
  #status{position:fixed; bottom:10px; left:10px; color:#fff;
    font-family:sans-serif; font-size:13px; z-index:3;}
</style>
</head>
<body>

<video id="camera" autoplay playsinline></video>
<div id="dot"></div>
<div id="status">Käynnistyy…</div>

<script>
const FOV_H = 60;   // kameran vaakasuuntainen näkökenttä (arvio)
const FOV_V = 40;   // pystysuuntainen näkökenttä
const dot = document.getElementById('dot');
const statusEl = document.getElementById('status');
const video = document.getElementById('camera');

let target = {lat: 60.192059, lon: 24.945831}; // Esimerkkikohde: Helsinki
let pos = null;
let heading = null;
let pitch = 0, roll = 0;

function toRad(d){return d*Math.PI/180;}
function toDeg(r){return r*180/Math.PI;}
const R = 6371000;
function bearing(lat1,lon1,lat2,lon2){
  const φ1=toRad(lat1),φ2=toRad(lat2),Δλ=toRad(lon2-lon1);
  const y=Math.sin(Δλ)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y,x))+360)%360;
}
function distance(lat1,lon1,lat2,lon2){
  const φ1=toRad(lat1),φ2=toRad(lat2);
  const dφ=φ2-φ1,dλ=toRad(lon2-lon1);
  const a=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}});
  video.srcObject = stream;
}

function initGeo(){
  navigator.geolocation.watchPosition(p=>{
    pos={lat:p.coords.latitude, lon:p.coords.longitude};
  },e=>statusEl.textContent="GPS virhe: "+e.message,
  {enableHighAccuracy:true, maximumAge:1000});
}

function onOrientation(e){
  // alpha: ympäri z-akselin, beta: kallistus, gamma: roll
  const screenAngle = (screen.orientation?.angle||0);
  heading = e.webkitCompassHeading ?? (360 - e.alpha + screenAngle) % 360;
  pitch = e.beta; roll = e.gamma;
}

function project(){
  if(!pos||heading===null) return;
  const bear = bearing(pos.lat,pos.lon,target.lat,target.lon);
  const dist = distance(pos.lat,pos.lon,target.lat,target.lon);

  const rel = ((bear - heading + 540)%360)-180; // -180..180
  const pitchAdj = -pitch; // negatiivinen = katso alas

  const halfH = FOV_H/2, halfV = FOV_V/2;

  if(Math.abs(rel)<halfH && Math.abs(pitchAdj)<halfV){
    // kohde ruudussa
    const x = (rel/halfH/2 + 0.5) * window.innerWidth;
    const y = (pitchAdj/halfV/2 + 0.5) * window.innerHeight;
    dot.style.left = x+"px";
    dot.style.top = y+"px";
    dot.style.display = 'block';
  } else {
    dot.style.display = 'none';
  }
  statusEl.textContent = `Etäisyys ${dist.toFixed(0)} m  suunta ${bear.toFixed(0)}°`;
}

async function initOrientation(){
  if (typeof DeviceOrientationEvent.requestPermission==='function'){
    const r = await DeviceOrientationEvent.requestPermission();
    if(r!=='granted'){statusEl.textContent="Suunta-lupa estetty";return;}
  }
  window.addEventListener('deviceorientation',onOrientation);
}

startCamera();
initGeo();
initOrientation();
setInterval(project,150);
</script>
</body>
</html>
