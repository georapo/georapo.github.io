<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Sijaintikohde</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #000;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #info-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
            color: white;
            z-index: 10;
        }

        #info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        #info-details {
            font-size: 14px;
        }

        #info-details > div {
            margin-bottom: 4px;
        }

        #error-message {
            margin-top: 8px;
            padding: 8px;
            background: rgba(239, 68, 68, 0.8);
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.9);
			background-image: url('./backgrnd.jpg');
			background-size: cover;
			background-position: center;   /* keskitet√§√§n t√§rke√§ osa kuvaa */
            background-repeat: no-repeat;
            z-index: 20;
            padding: 32px;
            text-align: center;
        }

        #start-screen h1 {
            color: white;
            font-size: 28px;
            margin: 16px 0 8px 0;
        }

        #start-screen p {
            color: #ccc;
            margin-bottom: 24px;
        }

        #start-button {
            padding: 12px 24px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #start-button:hover {
            background: #1d4ed8;
        }

        #fullscreen-button {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: rgba(0,0,0,0.6);
            border: 2px solid white;
            border-radius: 8px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 15;
            display: none;
        }

        #fullscreen-button:hover {
            background: rgba(0,0,0,0.8);
        }

        .instructions {
            margin-top: 32px;
            color: #999;
            font-size: 14px;
            max-width: 400px;
        }

        .instructions ul {
            text-align: left;
            margin-top: 8px;
            list-style-position: inside;
        }

        .instructions li {
            margin-bottom: 4px;
        }

        #target-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            color: white;
            z-index: 10;
            font-size: 14px;
        }

        .target-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .target-coords {
            color: #ccc;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Video stream -->
        <video id="video" autoplay playsinline></video>

        <!-- AR Canvas -->
        <canvas id="canvas"></canvas>

        <!-- Fullscreen button -->
        <button id="fullscreen-button" title="Koko n√§ytt√∂">‚õ∂</button>

        <!-- Info overlay -->
        <!-- Info overlay -->
        <div id="info-overlay" class="hidden">
            <div id="info-header">
                üìç GEOK√ÑTK√ñT AR 
            </div>
            <div id="info-details">
                <div id="location-info">Haetaan sijaintia...</div>
                <div id="accuracy-info"></div>
                <div id="heading-info"></div>
            </div>
            <div id="error-message"></div>
        </div>

        <!-- Start screen -->
        <div id="start-screen">
            <div style="font-size: 64px;">üì∑</div>
            <h1>GEOK√ÑTK√ñT AR</h1>
            <p>N√§e geok√§tk√∂n sijainti ymp√§rill√§si lis√§tyn todellisuuden avulla</p>
            <button id="start-button">
                üß≠ K√§ynnist√§ GEOK√ÑTK√ñT AR
            </button>
            <div class="instructions">
                <p>Huom:</p>
                <ul>
                    <li>Salli sijainti ja kamera</li>
                    <li>Toimii parhaiten mobiililaitteilla</li>
                    
                </ul>
            </div>
        </div>

        <!-- Target info -->
        <div id="target-info" class="hidden">
            <div class="target-name">Kohde: <span id="target-name"></span></div>
            <div class="target-coords" id="target-coords"></div>
        </div>
    </div>

    <script>
        // Muuttujat
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const infoOverlay = document.getElementById('info-overlay');
        const targetInfo = document.getElementById('target-info');
        const startButton = document.getElementById('start-button');
        const errorMessage = document.getElementById('error-message');
        const fullscreenButton = document.getElementById('fullscreen-button');
        const container = document.getElementById('container');

        let userLocation = null;
        let previousLocation = null;
        let movementHeading = null; // GPS-pohjainen kulkusuunta
        let deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
        let animationFrameId = null;

function toDegreesMinutes(coord) {
           const degrees = Math.floor(coord);
           const minutes = (Math.abs(coord - degrees) * 60).toFixed(3).padStart(6, '0');
           return `${degrees}¬∞ ${minutes}`;
        }
		
		function fromDegreesMinutes(dmString) {
          // Erotellaan asteet ja minuutit pisteen perusteella
          // esim. "60.10.248" ‚Üí ["60", "10", "248"]
          const parts = dmString.split('.');

          const degrees = parseInt(parts[0], 10);
          // Liitet√§√§n loput pisteen j√§lkeiset osat yhteen (jos niit√§ on useita)
          const minutes = parseFloat(parts.slice(1).join('.'));

          // Muutetaan desimaaliasteiksi
          return degrees + (minutes / 60);
        }
	
		const queryString = window.location.search;
		const urlParams = new URLSearchParams(queryString);
		const coords = urlParams.get('c').split(",");
		const gccode = urlParams.get('g');
		const gctype = urlParams.get('t');
		
		const c1 = (coords[0].split('.').length == 3 ? fromDegreesMinutes(coords[0]) : coords[0]);
		const c2 = (coords[1].split('.').length == 3 ? fromDegreesMinutes(coords[1]) : coords[1]);

		//sis√§sesti laskuissa koordinaatit hallitaan dd.dddd, mutta esitett√§ess√§ k√§ytt√∂liittym√§ss√§ 'DD MM.mmm'
		
        // Kohteen koordinaatit (Helsingin tuomiokirkko esimerkkin√§)
        const targetLocation = {
			lat: parseFloat(c1),  //lat: 60.1708,
			lng: parseFloat(c2),  //lng: 24.9522,
			name: gccode  //name: "Kohde"
        };


        // P√§ivit√§ kohteen tiedot
        document.getElementById('target-name').textContent = targetLocation.name;
        document.getElementById('target-coords').textContent = 
            `${toDegreesMinutes(targetLocation.lat)}, ${toDegreesMinutes(targetLocation.lng)}`;
			
        // N√§yt√§ virheviesti
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // Pyyd√§ orientaatio-oikeus (iOS)
        async function requestOrientationPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        showError('Orientaatio-oikeus ev√§tty');
                        return false;
                    }
                } catch (err) {
                    showError('Virhe orientaatio-oikeutta pyydett√§ess√§: ' + err.message);
                    return false;
                }
            }
            return true;
        }

        // K√§ynnist√§ kamera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                return true;
            } catch (err) {
                showError('Kameran k√§ynnistys ep√§onnistui: ' + err.message);
                return false;
            }
        }

        // Hae sijainti
        function startGeolocation() {
            if (!navigator.geolocation) {
                showError('Geolocation ei tuettu');
                return;
            }

            navigator.geolocation.watchPosition(
                (position) => {
                    const newLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: position.timestamp
                    };

                    // Jos on edellinen sijainti, laske kulkusuunta
                    if (previousLocation) {
                        const distance = calculateDistance(
                            previousLocation.lat,
                            previousLocation.lng,
                            newLocation.lat,
                            newLocation.lng
                        );

                        // P√§ivit√§ suunta vain jos liikuttu tarpeeksi (v√§hint√§√§n 2m)
                        // T√§m√§ v√§ltt√§√§ h√§iri√∂t√§ GPS-ep√§tarkkuudesta
                        if (distance > 2) {
                            movementHeading = calculateBearing(
                                previousLocation.lat,
                                previousLocation.lng,
                                newLocation.lat,
                                newLocation.lng
                            );
                            previousLocation = newLocation;
                        }
                    } else {
                        // Ensimm√§inen sijainti
                        previousLocation = newLocation;
                    }

                    userLocation = newLocation;
                    updateLocationInfo();
                },
                (err) => {
                    showError('Sijainnin haku ep√§onnistui: ' + err.message);
                },
                { enableHighAccuracy: true, maximumAge: 0 }
            );
        }

        // P√§ivit√§ sijaintitiedot
        function updateLocationInfo() {
            if (!userLocation) return;
            document.getElementById('location-info').textContent = 
                `Oma sijainti: ${toDegreesMinutes(userLocation.lat.toFixed(6))}, ${toDegreesMinutes(userLocation.lng.toFixed(6))}`;
				
				
            document.getElementById('accuracy-info').textContent = 
                `Tarkkuus: ¬±${userLocation.accuracy.toFixed(0)}m`;
            
            if (movementHeading !== null) {
                document.getElementById('heading-info').textContent = 
                    `Kulkusuunta (GPS): ${movementHeading.toFixed(0)}¬∞`;
            } else {
                document.getElementById('heading-info').textContent = 
                    `Kulkusuunta: Odottaa liikett√§...`;
            }
        }

        // Kuuntele orientaatiota (k√§ytet√§√§n vain kameran kallistukseen, ei suuntaan)
        function startOrientationTracking() {
            window.addEventListener('deviceorientation', (event) => {
                deviceOrientation = {
                    alpha: event.alpha || 0,   // Ei en√§√§ k√§ytet√§ suuntaan
                    beta: event.beta || 0,     // Kallistus eteen/taakse
                    gamma: event.gamma || 0    // Kallistus sivulle
                };
            });
        }

        // Laske et√§isyys (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // Laske suuntakulma
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                      Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
            const Œ∏ = Math.atan2(y, x);

            return (Œ∏ * 180 / Math.PI + 360) % 360;
        }

        // Piirry AR-n√§kym√§
        function drawAR() {
            if (!userLocation || movementHeading === null) {
                animationFrameId = requestAnimationFrame(drawAR);
                return;
            }

            // Aseta canvasin koko videon mukaan
            canvas.width = video.videoWidth || canvas.width;
            canvas.height = video.videoHeight || canvas.height;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Laske kohteen sijainti
            const distance = calculateDistance(
                userLocation.lat,
                userLocation.lng,
                targetLocation.lat,
                targetLocation.lng
            );

            const targetBearing = calculateBearing(
                userLocation.lat,
                userLocation.lng,
                targetLocation.lat,
                targetLocation.lng
            );

            // Laske suhteellinen kulma kohteeseen kulkusuunnasta
            // movementHeading = mihin suuntaan kuljet
            // targetBearing = miss√§ suunnassa kohde on
            let relativeBearing = targetBearing - movementHeading;
            if (relativeBearing > 180) relativeBearing -= 360;
            if (relativeBearing < -180) relativeBearing += 360;

            // FOV (field of view) - n√§k√∂kentt√§
            const horizontalFOV = 60; // Vaakasuuntainen n√§k√∂kentt√§
            
            // Tarkista onko kohde n√§kyviss√§ horisontaalisesti
            if (Math.abs(relativeBearing) < horizontalFOV / 2) {
                // Laske kohteen X-sijainti (horisontaalinen)
                // Kohde n√§kyy keskell√§ kun relativeBearing = 0 (suoraan edess√§)
                // Kohde on oikealla kun relativeBearing > 0
                // Kohde on vasemmalla kun relativeBearing < 0
                const normalizedX = relativeBearing / (horizontalFOV / 2); // -1 ... 1
                const x = canvas.width / 2 + normalizedX * (canvas.width / 2);
                
                // Y-sijainti keskell√§ (voidaan laajentaa korkeudella my√∂hemmin)
                const y = canvas.height / 2;

                // Piirry punainen ympyr√§
                ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, 2 * Math.PI);
                ctx.fill();

                // Piirry kohteen nimi
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.shadowColor = 'black';
                ctx.shadowBlur = 4;
                ctx.fillText(targetLocation.name, x, y - 30);
                
                // Piirry et√§isyys
                ctx.fillText(`${distance.toFixed(0)}m`, x, y + 45);
                
                // Piirry suhteellinen kulma (debug)
                ctx.font = '12px Arial';
                ctx.fillText(`${relativeBearing.toFixed(0)}¬∞ (rel)`, x, y + 65);
                ctx.shadowBlur = 0;
            }

            animationFrameId = requestAnimationFrame(drawAR);
        }

        // Fullscreen-toiminnot
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Siirry fullscreeniin
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) { // Safari
                    container.webkitRequestFullscreen();
                } else if (container.mozRequestFullScreen) { // Firefox
                    container.mozRequestFullScreen();
                } else if (container.msRequestFullscreen) { // IE/Edge
                    container.msRequestFullscreen();
                }
            } else {
                // Poistu fullscreenist√§
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // P√§ivit√§ fullscreen-napin ulkoasu
        function updateFullscreenButton() {
            if (document.fullscreenElement) {
                fullscreenButton.textContent = '‚äó'; // Exit fullscreen ikoni
                fullscreenButton.title = 'Poistu koko n√§yt√∂st√§';
            } else {
                fullscreenButton.textContent = '‚õ∂'; // Enter fullscreen ikoni
                fullscreenButton.title = 'Koko n√§ytt√∂';
            }
        }

        // Kuuntele fullscreen-muutoksia
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('mozfullscreenchange', updateFullscreenButton);
        document.addEventListener('MSFullscreenChange', updateFullscreenButton);

        // Fullscreen-napin toiminto
        fullscreenButton.addEventListener('click', toggleFullscreen);

        // K√§ynnist√§ AR
        startButton.addEventListener('click', async () => {
            const orientationOk = await requestOrientationPermission();
            if (!orientationOk) return;

            const cameraOk = await startCamera();
            if (!cameraOk) return;

            startScreen.classList.add('hidden');
            infoOverlay.classList.remove('hidden');
            targetInfo.classList.remove('hidden');
            fullscreenButton.style.display = 'block';

            // Siirry automaattisesti fullscreeniin
            try {
                if (container.requestFullscreen) {
                    await container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    await container.webkitRequestFullscreen();
                } else if (container.mozRequestFullScreen) {
                    await container.mozRequestFullScreen();
                } else if (container.msRequestFullscreen) {
                    await container.msRequestFullscreen();
                }
            } catch (err) {
                console.log('Fullscreen ei onnistunut:', err);
                // Jatka silti normaalisti
            }

            startGeolocation();
            startOrientationTracking();
            
            // Odota ett√§ video on valmis
            video.addEventListener('loadeddata', () => {
                drawAR();
            });
        });
    </script>
</body>
</html>